{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "learnings.schema.json",
  "title": "Loa Learnings Schema",
  "description": "Schema for Loa compound learnings - patterns, gaps, and improvements discovered during development sessions. Supports both effectiveness tracking (JSON) and feedback capture (YAML).",
  "type": "object",
  "required": ["learnings"],
  "oneOf": [
    {
      "required": ["version"],
      "description": "JSON format for learnings.json (effectiveness registry)"
    },
    {
      "required": ["schema_version"],
      "description": "YAML format for feedback/*.yaml files"
    }
  ],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this schema file"
    },
    "version": {
      "type": "string",
      "description": "Schema version (JSON format)",
      "pattern": "^[0-9]+\\.[0-9]+$"
    },
    "schema_version": {
      "type": "integer",
      "const": 1,
      "description": "Schema version (YAML format)"
    },
    "date": {
      "type": "string",
      "format": "date",
      "description": "Date of the feedback file (YYYY-MM-DD)"
    },
    "cycle": {
      "type": "string",
      "pattern": "^cycle-[0-9]+$",
      "description": "Development cycle ID (e.g., cycle-001)"
    },
    "last_updated": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "ISO timestamp of last update"
    },
    "description": {
      "type": "string",
      "description": "Human-readable description of this registry"
    },
    "learnings": {
      "type": "array",
      "description": "Array of tracked learnings with effectiveness data",
      "items": {
        "$ref": "#/definitions/learning"
      }
    }
  },
  "definitions": {
    "learning": {
      "type": "object",
      "required": ["id"],
      "description": "A learning entry - supports both effectiveness tracking (JSON) and feedback capture (YAML) formats",
      "properties": {
        "id": {
          "type": "string",
          "description": "Learning identifier (L-NNNN for feedback, skill name for effectiveness)"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When the learning was captured (YAML format)"
        },
        "type": {
          "type": "string",
          "description": "Category of learning (YAML format)",
          "enum": ["pattern", "gap", "friction", "improvement", "anti_pattern"]
        },
        "title": {
          "type": "string",
          "maxLength": 200,
          "description": "Brief title describing the learning"
        },
        "context": {
          "type": "string",
          "maxLength": 500,
          "description": "When/where this was discovered"
        },
        "trigger": {
          "type": "string",
          "maxLength": 500,
          "description": "Conditions that indicate this learning applies"
        },
        "solution": {
          "type": "string",
          "maxLength": 2000,
          "description": "The pattern/solution discovered"
        },
        "verified": {
          "type": "boolean",
          "default": false,
          "description": "Whether the learning has been verified to work"
        },
        "quality_gates": {
          "$ref": "#/definitions/quality_gates",
          "description": "Quality assessment scores"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9-]*$"
          },
          "description": "Relevant tags for categorization"
        },
        "status": {
          "type": "string",
          "description": "Current status of the learning",
          "enum": ["active", "deprecated", "superseded", "pending_review"]
        },
        "superseded_by": {
          "type": "string",
          "description": "ID of learning that supersedes this one"
        },
        "related": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "IDs of related learnings"
        },
        "source": {
          "oneOf": [
            {
              "type": "string",
              "description": "How this learning was created (JSON format)",
              "enum": ["pattern", "inline_extraction", "manual", "synthesis"]
            },
            {
              "$ref": "#/definitions/source_object",
              "description": "Origin information (YAML format)"
            }
          ]
        },
        "source_pattern_id": {
          "type": ["string", "null"],
          "description": "Source pattern ID if created from batch retrospective"
        },
        "created": {
          "type": "string",
          "format": "date-time",
          "description": "When this learning was first extracted"
        },
        "effectiveness_score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Calculated effectiveness score (0-100)"
        },
        "effectiveness_tier": {
          "type": "string",
          "description": "Tier based on effectiveness score",
          "enum": ["high", "medium", "low", "ineffective"]
        },
        "retrieval_priority": {
          "type": "number",
          "minimum": 0,
          "maximum": 2,
          "default": 1,
          "description": "Retrieval weight multiplier (high tier=2x, ineffective=0.5x)"
        },
        "applications": {
          "type": "array",
          "description": "Record of each time this learning was applied",
          "items": {
            "$ref": "#/definitions/application"
          }
        },
        "retrieval_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of times this learning was retrieved"
        },
        "last_retrieved": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "When this learning was last retrieved"
        },
        "dismissal_count": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Number of times user dismissed this learning"
        },
        "flagged_for_review": {
          "type": "boolean",
          "default": false,
          "description": "Whether this learning needs human review"
        },
        "pruning_candidate": {
          "type": "boolean",
          "default": false,
          "description": "Whether this learning is queued for potential archival"
        },
        "metadata": {
          "type": "object",
          "description": "Additional learning metadata",
          "additionalProperties": true
        }
      }
    },
    "application": {
      "type": "object",
      "required": ["timestamp", "task_id", "type", "outcome"],
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When the learning was applied"
        },
        "task_id": {
          "type": "string",
          "description": "Task context where learning was applied"
        },
        "type": {
          "type": "string",
          "description": "How the learning was applied",
          "enum": ["explicit", "implicit", "prompted"]
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Application detection confidence"
        },
        "code_location": {
          "type": ["string", "null"],
          "description": "Code file and line where learning was applied"
        },
        "outcome": {
          "type": "string",
          "description": "Result of applying the learning",
          "enum": ["success", "failure", "unknown", "pending"]
        },
        "feedback_signals": {
          "$ref": "#/definitions/feedback_signals"
        }
      }
    },
    "feedback_signals": {
      "type": "object",
      "description": "Feedback signals for effectiveness scoring",
      "properties": {
        "task_completed": {
          "type": "boolean",
          "description": "Task was marked complete (+3)"
        },
        "no_errors": {
          "type": "boolean",
          "description": "No error events during task (+2)"
        },
        "no_revert": {
          "type": "boolean",
          "description": "No git revert within 24h (+2)"
        },
        "faster_completion": {
          "type": "boolean",
          "description": "Completed faster than median (+1)"
        },
        "user_positive": {
          "type": "boolean",
          "description": "User gave positive feedback (+3)"
        },
        "user_negative": {
          "type": "boolean",
          "description": "User gave negative feedback (-5)"
        }
      }
    },
    "quality_gates": {
      "type": "object",
      "description": "Quality assessment scores (1-10 scale) for YAML feedback format",
      "properties": {
        "discovery_depth": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "description": "How deeply the learning was investigated"
        },
        "reusability": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "description": "How applicable to other contexts"
        },
        "trigger_clarity": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "description": "How clear the activation conditions are"
        },
        "verification": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "description": "How well verified the solution is"
        }
      },
      "additionalProperties": false
    },
    "source_object": {
      "type": "object",
      "description": "Origin information for YAML feedback format",
      "properties": {
        "sprint": {
          "type": "string",
          "pattern": "^sprint-[0-9]+$",
          "description": "Sprint where learning was discovered"
        },
        "task": {
          "type": "string",
          "pattern": "^T[0-9]+\\.[0-9]+$",
          "description": "Task ID (e.g., T1.2)"
        },
        "agent": {
          "type": "string",
          "description": "Agent that discovered the learning"
        },
        "session_id": {
          "type": "string",
          "description": "Claude Code session ID"
        },
        "file": {
          "type": "string",
          "description": "File where learning was applied"
        },
        "line": {
          "type": "integer",
          "minimum": 1,
          "description": "Line number in file"
        }
      },
      "additionalProperties": false
    },
    "effectiveness": {
      "type": "object",
      "description": "Tracking of learning application and success for YAML format",
      "properties": {
        "applied_count": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Number of times this learning has been applied"
        },
        "success_rate": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "default": 0.0,
          "description": "Ratio of successful applications (0.0-1.0)"
        },
        "last_applied": {
          "type": "string",
          "format": "date-time",
          "description": "When this learning was last applied"
        }
      },
      "additionalProperties": false
    }
  }
}
