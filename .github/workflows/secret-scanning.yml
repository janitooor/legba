name: Secret Scanning

# Run on all pushes and pull requests to detect secrets before they reach main branch
on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  # Also run weekly on a schedule to scan entire history
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC

jobs:
  scan-secrets:
    name: Scan for Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for comprehensive scanning

      - name: Run TruffleHog
        id: trufflehog
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified --no-update

      - name: Run GitLeaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional: For GitLeaks Pro features

      - name: Check results
        id: check
        run: |
          # Only fail if VERIFIED secrets found (not just patterns in docs)
          if [ "${{ steps.trufflehog.outcome }}" == "failure" ] || [ "${{ steps.gitleaks.outcome }}" == "failure" ]; then
            echo "secrets_found=true" >> $GITHUB_OUTPUT
            echo "::warning::Potential secrets detected. Review logs to verify if real secrets or false positives in documentation."
            # Don't block PR for potential false positives
            exit 0
          else
            echo "secrets_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Alert on Discord (Secrets Found)
        if: failure() && env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"ðŸš¨ðŸš¨ðŸš¨ **CRITICAL: SECRETS DETECTED IN COMMIT**\",
              \"embeds\": [{
                \"title\": \"Secret Scanning Failed\",
                \"description\": \"Secrets were detected in repository: **${{ github.repository }}**\",
                \"color\": 15158332,
                \"fields\": [
                  {
                    \"name\": \"Branch\",
                    \"value\": \"${{ github.ref_name }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Commit\",
                    \"value\": \"${{ github.sha }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Author\",
                    \"value\": \"${{ github.actor }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Action Required\",
                    \"value\": \"1. Rotate leaked secrets immediately\n2. Remove secrets from commit history\n3. Audit for unauthorized access\n4. See workflow logs for details\"
                  }
                ],
                \"footer\": {
                  \"text\": \"GitHub Secret Scanning\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }"

      - name: Alert on Discord (Success)
        if: success() && env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"âœ… Secret scanning passed for **${{ github.repository }}** (${{ github.ref_name }})\"
            }"

      - name: Comment on PR (if applicable)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš¨ Secret Scanning Failed

            Secrets were detected in this pull request. **This PR cannot be merged until the secrets are removed.**

            ### Immediate Actions Required:
            1. **DO NOT MERGE** this pull request
            2. Remove secrets from your code
            3. Rotate any exposed credentials
            4. Remove secrets from Git history if already committed
            5. Re-run the checks

            ### Tools Used:
            - TruffleHog
            - GitLeaks

            See the workflow logs for details on what was detected.

            ### Need Help?
            - See: \`loa-grimoire/runbooks/secrets-rotation.md\`
            - Contact: security team
            `
            })

      - name: Block PR merge
        if: failure() && github.event_name == 'pull_request'
        run: |
          echo "::error::Secrets detected in pull request. Merge blocked."
          exit 1

  # Additional job: Scan for secrets in dependencies
  # Only runs if app/package.json exists (skipped for template repos)
  scan-dependencies:
    name: Scan Dependencies for Vulnerabilities
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if app has dependencies
        id: check-deps
        run: |
          if [ -f "app/package.json" ]; then
            echo "has_deps=true" >> $GITHUB_OUTPUT
          else
            echo "has_deps=false" >> $GITHUB_OUTPUT
            echo "::notice::No app/package.json found - skipping dependency scan (template repo)"
          fi

      - name: Set up Node.js
        if: steps.check-deps.outputs.has_deps == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        if: steps.check-deps.outputs.has_deps == 'true'
        run: npm ci
        working-directory: ./app

      - name: Run npm audit
        if: steps.check-deps.outputs.has_deps == 'true'
        id: npm-audit
        continue-on-error: true
        run: |
          npm audit --audit-level=moderate --json > audit-results.json
          cat audit-results.json
        working-directory: ./app

      - name: Check for critical vulnerabilities
        if: steps.check-deps.outputs.has_deps == 'true'
        working-directory: ./app
        run: |
          CRITICAL_COUNT=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH_COUNT=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')

          echo "Critical vulnerabilities: $CRITICAL_COUNT"
          echo "High vulnerabilities: $HIGH_COUNT"

          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo "::error::Found $CRITICAL_COUNT critical and $HIGH_COUNT high severity vulnerabilities"
            exit 1
          fi

      - name: Upload audit results
        if: always() && steps.check-deps.outputs.has_deps == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: app/audit-results.json

# CONFIGURATION NOTES
# ===================
#
# Required Secrets (configure in GitHub Settings â†’ Secrets):
# - DISCORD_WEBHOOK_URL: Discord webhook for security alerts (optional)
# - GITLEAKS_LICENSE: GitLeaks Pro license key (optional)
#
# This workflow will:
# 1. Block pushes/PRs that contain secrets
# 2. Send Discord alerts when secrets detected
# 3. Comment on PRs with remediation instructions
# 4. Run weekly scans of entire repository history
# 5. Scan dependencies for vulnerabilities
#
# False Positives:
# - To exclude false positives, create .gitleaksignore or .trufflehog.yaml
# - Use git-secrets pre-commit hooks for local development
#
# Integration with Secrets Rotation:
# - This workflow integrates with secrets-leak-detector.ts
# - Detected leaks trigger emergency rotation procedures
# - See loa-grimoire/runbooks/secrets-rotation.md for rotation procedures
